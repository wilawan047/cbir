{% extends '_admin_layout.html' %}

{% block title %}{{ title }}{% endblock %}

{% block content %}
<div class="container mx-auto px-4 py-8">
    <!-- Page Header -->
    <div class="mb-8">
        <h1 class="text-2xl font-bold text-gray-800 flex items-center">
            <i class="fas fa-chart-line text-blue-600 mr-3"></i> {{ title }}
        </h1>
        <p class="text-gray-600 mt-1">รายงานสถิติการเข้าชมบ้านพักอาศัย</p>
    </div>

    <!-- Date Range Filter -->
    <div class="bg-white rounded-xl shadow-sm overflow-hidden mb-8">
        <div class="bg-gradient-to-r from-blue-50 to-blue-100 px-6 py-4 border-b border-gray-200">
            <h2 class="text-lg font-semibold text-gray-800">
                <i class="fas fa-calendar-alt text-blue-600 mr-2"></i> ตัวกรองช่วงเวลา
            </h2>
        </div>
        <div class="p-6">
            <div class="flex flex-wrap gap-4">
                <a href="{{ url_for('admin_view_stats', days=7) }}" 
                   class="px-4 py-2 rounded-full text-sm font-medium {% if selected_days == 7 %}bg-blue-600 text-white{% else %}bg-white border border-gray-300 text-gray-700 hover:bg-gray-50{% endif %}">
                    7 วันที่ผ่านมา
                </a>
                <a href="{{ url_for('admin_view_stats', days=30) }}" 
                   class="px-4 py-2 rounded-full text-sm font-medium {% if selected_days == 30 %}bg-blue-600 text-white{% else %}bg-white border border-gray-300 text-gray-700 hover:bg-gray-50{% endif %}">
                    30 วันที่ผ่านมา
                </a>
                <a href="{{ url_for('admin_view_stats', days=90) }}" 
                   class="px-4 py-2 rounded-full text-sm font-medium {% if selected_days == 90 %}bg-blue-600 text-white{% else %}bg-white border border-gray-300 text-gray-700 hover:bg-gray-50{% endif %}">
                    90 วันที่ผ่านมา
                </a>
            </div>
        </div>
    </div>

    <!-- Stats Overview -->
    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 mb-8">
        <!-- Total Views Card -->
        <div class="bg-white rounded-xl shadow-sm p-6 hover:shadow-md transition-shadow">
            <div class="flex items-center">
                <div class="p-3 rounded-lg bg-blue-50 text-blue-600 mr-4">
                    <i class="fas fa-eye text-xl"></i>
                </div>
                <div>
                    <p class="text-sm text-gray-500">ยอดเข้าชมทั้งหมด</p>
                    <h3 class="text-2xl font-bold text-gray-800">{{ "{:,.0f}".format(view_counts|sum if view_counts else 0) }}</h3>
                </div>
            </div>
        </div>

        <!-- Average Daily Views -->
        <div class="bg-white rounded-xl shadow-sm p-6 hover:shadow-md transition-shadow">
            <div class="flex items-center">
                <div class="p-3 rounded-lg bg-green-50 text-green-600 mr-4">
                    <i class="fas fa-chart-line text-xl"></i>
                </div>
                <div>
                    <p class="text-sm text-gray-500">ยอดเข้าชมเฉลี่ยต่อวัน</p>
                    <h3 class="text-2xl font-bold text-gray-800">
                        {{ "{:,.1f}".format(view_counts|sum / selected_days if view_counts and selected_days > 0 else 0) }}
                    </h3>
                </div>
            </div>
        </div>

        <!-- Most Viewed House Type -->
        <div class="bg-white rounded-xl shadow-sm p-6 hover:shadow-md transition-shadow">
            <div class="flex items-center">
                <div class="p-3 rounded-lg bg-purple-50 text-purple-600 mr-4">
                    <i class="fas fa-home text-xl"></i>
                </div>
                <div>
                    <p class="text-sm text-gray-500">ประเภทบ้านยอดนิยม</p>
                    <h3 class="text-xl font-bold text-gray-800 truncate">
                        {{ views_by_type[0].name if views_by_type else '-' }}
                    </h3>
                </div>
            </div>
        </div>

    </div>

    <!-- Charts Row -->
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 mb-8">
        <!-- View Trends Chart -->
        <div class="bg-white rounded-xl shadow-sm overflow-hidden">
            <div class="bg-gradient-to-r from-blue-50 to-blue-100 px-6 py-4 border-b border-gray-200">
                <h2 class="text-lg font-semibold text-gray-800">
                    <i class="fas fa-chart-line text-blue-600 mr-2"></i> แนวโน้มการเข้าชม
                </h2>
                <p class="text-sm text-gray-600 mt-1">จำนวนการเข้าชมย้อนหลัง {{ selected_days }} วัน</p>
            </div>
            <div class="p-6">
                <div class="chart-container" style="height: 300px;">
                    <canvas id="viewTrendsChart"></canvas>
                </div>
            </div>
        </div>

        <!-- Views by House Type -->
        <div class="bg-white rounded-xl shadow-sm overflow-hidden">
            <div class="bg-gradient-to-r from-blue-50 to-blue-100 px-6 py-4 border-b border-gray-200">
                <h2 class="text-lg font-semibold text-gray-800">
                    <i class="fas fa-chart-pie text-blue-600 mr-2"></i> การเข้าชมแยกตามประเภทบ้าน
                </h2>
                <p class="text-sm text-gray-600 mt-1">สัดส่วนการเข้าชมทั้งหมด</p>
            </div>
            <div class="p-6">
                <div class="chart-container" style="height: 300px;">
                    <canvas id="viewsByTypeChart"></canvas>
                </div>
            </div>
        </div>
    </div>

    <!-- Most Viewed Houses Table -->
    <div class="bg-white rounded-xl shadow-sm overflow-hidden mb-8">
        <div class="bg-gradient-to-r from-blue-50 to-blue-100 px-6 py-4 border-b border-gray-200">
            <h2 class="text-lg font-semibold text-gray-800">
                <i class="fas fa-list-ol text-blue-600 mr-2"></i> บ้านยอดนิยม 5 อันดับแรก
            </h2>
            <p class="text-sm text-gray-600 mt-1">เรียงตามจำนวนการเข้าชมทั้งหมด</p>
        </div>
        <div class="overflow-x-auto">
            <table class="min-w-full divide-y divide-gray-200">
                <thead class="bg-gray-50">
                    <tr>
                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                            ลำดับ
                        </th>
                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                            ชื่อบ้าน
                        </th>
                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                            ประเภท
                        </th>
                        <th scope="col" class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">
                            จำนวนการเข้าชม
                        </th>
                    </tr>
                </thead>
                <tbody class="bg-white divide-y divide-gray-200">
                    {% for house in most_viewed_houses %}
                    <tr class="hover:bg-gray-50">
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                            {{ loop.index }}
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap">
                            <div class="text-sm font-medium text-gray-900">{{ house.name }}</div>
                            <div class="text-sm text-gray-500">{{ house.project_name or 'ไม่มีชื่อโครงการ' }}</div>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                            {{ house.type_name or '-' }}
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
                            <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-green-100 text-green-800">
                                {{ "{:,.0f}".format(house.view_count or 0) }}
                            </span>
                        </td>
                    </tr>
                    {% else %}
                    <tr>
                        <td colspan="4" class="px-6 py-4 text-center text-sm text-gray-500">
                            ไม่พบข้อมูลการเข้าชม
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>

<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    // View Trends Chart
    const viewTrendsCtx = document.getElementById('viewTrendsChart');
    if (viewTrendsCtx) {
        // Get data from template variables and parse as JSON
        const viewDates = JSON.parse('{{ view_dates|tojson|safe }}');
        const viewCounts = JSON.parse('{{ view_counts|tojson|safe }}');
        
        // Debug log
        console.log('View Dates:', viewDates);
        console.log('View Counts:', viewCounts);
        
        const viewTrendsChart = new Chart(viewTrendsCtx, {
            type: 'line',
            data: {
                labels: viewDates,
                datasets: [{
                    label: 'จำนวนการเข้าชม',
                    data: viewCounts,
                    backgroundColor: 'rgba(59, 130, 246, 0.1)',
                    borderColor: 'rgba(59, 130, 246, 0.8)',
                    borderWidth: 2,
                    tension: 0.3,
                    fill: true,
                    pointBackgroundColor: 'white',
                    pointBorderColor: 'rgba(59, 130, 246, 0.8)',
                    pointBorderWidth: 2,
                    pointRadius: 4,
                    pointHoverRadius: 6,
                    pointHoverBackgroundColor: 'white',
                    pointHoverBorderColor: 'rgba(59, 130, 246, 1)',
                    pointHoverBorderWidth: 2
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        display: false
                    },
                    tooltip: {
                        backgroundColor: 'white',
                        titleColor: '#1f2937',
                        bodyColor: '#4b5563',
                        borderColor: '#e5e7eb',
                        borderWidth: 1,
                        padding: 12,
                        boxShadow: '0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06)',
                        callbacks: {
                            label: function(context) {
                                return 'จำนวนการเข้าชม: ' + context.raw.toLocaleString();
                            }
                        }
                    }
                },
                scales: {
                    x: {
                        grid: {
                            display: false
                        },
                        ticks: {
                            color: '#6b7280',
                            maxRotation: 45,
                            minRotation: 45
                        }
                    },
                    y: {
                        beginAtZero: true,
                        grid: {
                            color: 'rgba(229, 231, 235, 0.5)'
                        },
                        ticks: {
                            color: '#6b7280',
                            callback: function(value) {
                                return value.toLocaleString();
                            }
                        }
                    }
                }
            }
        });
    }

    // Views by Type Chart
    const viewsByTypeCtx = document.getElementById('viewsByTypeChart');
    if (viewsByTypeCtx) {
        // Get and parse views by type data
        const viewsByType = JSON.parse('{{ views_by_type|tojson|safe }}');
        
        // Debug log
        console.log('Views by Type:', viewsByType);
        
        // Extract labels and data
        const typeNames = viewsByType.map(item => item.name);
        const typeCounts = viewsByType.map(item => item.view_count);
        
        const viewsByTypeData = {
            labels: typeNames,
            datasets: [{
                data: typeCounts,
                backgroundColor: [
                    'rgba(59, 130, 246, 0.8)',
                    'rgba(99, 102, 241, 0.8)',
                    'rgba(139, 92, 246, 0.8)',
                    'rgba(168, 85, 247, 0.8)',
                    'rgba(192, 132, 252, 0.8)',
                    'rgba(79, 70, 229, 0.8)',
                    'rgba(67, 56, 202, 0.8)'
                ],
                borderWidth: 0,
                hoverOffset: 10
            }]
        };

        const viewsByTypeChart = new Chart(viewsByTypeCtx, {
            type: 'doughnut',
            data: viewsByTypeData,
            options: {
                responsive: true,
                maintainAspectRatio: false,
                cutout: '70%',
                plugins: {
                    legend: {
                        position: 'right',
                        labels: {
                            padding: 20,
                            usePointStyle: true,
                            pointStyle: 'circle',
                            color: '#4b5563',
                            font: {
                                family: '"Kanit", sans-serif'
                            }
                        }
                    },
                    tooltip: {
                        backgroundColor: 'white',
                        titleColor: '#1f2937',
                        bodyColor: '#4b5563',
                        borderColor: '#e5e7eb',
                        borderWidth: 1,
                        padding: 12,
                        boxShadow: '0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06)',
                        callbacks: {
                            label: function(context) {
                                const label = context.label || '';
                                const value = context.raw || 0;
                                const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                const percentage = total > 0 ? Math.round((value / total) * 100) : 0;
                                return `${label}: ${value.toLocaleString()} (${percentage}%)`;
                            }
                        }
                    }
                }
            }
        });
    }
});

// Update chart on window resize
window.addEventListener('resize', function() {
    viewTrendsChart.resize();
    viewsByTypeChart.resize();
});
</script>
{% endblock %}
